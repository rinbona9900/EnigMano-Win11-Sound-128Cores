name: "‚ö°üîê‚úã mystraSIGIL - A Virtual Fortress"

on:
  workflow_dispatch:
    inputs:
      RUNNER_PROFILE:
        description: "Select mystraSIGIL machine profile"
        required: true
        type: choice
        default: win-128-core
        options:
          - win-64-core
          - win-128-core
          - win-nextgen
          - win-latest
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless (Windows)."
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 3)"
        required: false
        default: "3"

permissions:
  contents: read

jobs:
  resolve-runner:
    name: "Bootstrap"
    runs-on: windows-latest

    outputs:
      runner_label: ${{ steps.resolve.outputs.runner_label }}

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üß≠ Resolve runner label"
        id: resolve
        env:
          PROFILE: ${{ github.event.inputs.RUNNER_PROFILE }}
          MAP_URL: "https://gitlab.com/ShahzaibYT/test/-/raw/main/mystraSIGIL-runner-map.json"
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          function Set-ResolveOutput([string]$runnerLabel) {
            "runner_label=$runnerLabel"     >> $env:GITHUB_OUTPUT
          }

          function Resolve-Property([object]$obj, [string]$name) {
            if ($null -eq $obj) { return $null }
            $prop = $obj.PSObject.Properties[$name]
            if ($null -eq $prop) { return $null }
            return $prop.Value
          }

          if ($env:GITLAB_TOKEN) { Write-Host "::add-mask::$($env:GITLAB_TOKEN)" }

          $selectedProfile = "$($env:PROFILE)"
          $mapUrl = "$($env:MAP_URL)"
          if ([string]::IsNullOrWhiteSpace($mapUrl)) {
            throw "MAP_URL is empty. Set a valid hosted GitLab raw JSON URL in the workflow."
          }

          try {
            $headers = @{}
            if ($env:GITLAB_TOKEN) {
              $headers['PRIVATE-TOKEN'] = $env:GITLAB_TOKEN
              $headers['Authorization'] = "Bearer $($env:GITLAB_TOKEN)"
            }

            $resp = $null
            for ($i = 1; $i -le 3; $i++) {
              try {
                if ($headers.Count -gt 0) {
                  $resp = Invoke-WebRequest -Uri $mapUrl -Headers $headers -UseBasicParsing -TimeoutSec 45
                } else {
                  $resp = Invoke-WebRequest -Uri $mapUrl -UseBasicParsing -TimeoutSec 45
                }
                break
              } catch {
                if ($i -eq 3) { throw }
                Start-Sleep -Seconds (2 * $i)
              }
            }

            if ([string]::IsNullOrWhiteSpace($resp.Content)) {
              throw "Hosted map returned empty content."
            }

            $cfg = $resp.Content | ConvertFrom-Json

            $profiles = Resolve-Property $cfg 'profiles'
            if ($null -eq $profiles) {
              throw "Invalid map: missing 'profiles' object."
            }

            $aliases = Resolve-Property $cfg 'aliases'
            $effectiveProfile = $selectedProfile
            if ($null -ne $aliases) {
              $aliasTarget = Resolve-Property $aliases $selectedProfile
              if (-not [string]::IsNullOrWhiteSpace("$aliasTarget")) {
                $effectiveProfile = "$aliasTarget"
              }
            }

            $runnerLabel = Resolve-Property $profiles $effectiveProfile
            if ([string]::IsNullOrWhiteSpace("$runnerLabel")) {
              $available = @($profiles.PSObject.Properties.Name) -join ', '
              throw "Profile '$selectedProfile' (effective '$effectiveProfile') not found in hosted map. Available: $available"
            }

            $allowed = Resolve-Property $cfg 'allowed_runners'
            if ($null -eq $allowed -or @($allowed).Count -eq 0) {
              throw "Invalid map: missing or empty 'allowed_runners' array."
            } else {
              $allowed = @($allowed | ForEach-Object { "$_".Trim() })
            }

            if ($allowed -notcontains "$runnerLabel") {
              throw "Resolved runner '$runnerLabel' is not in allowlist: $($allowed -join ', ')"
            }

            Set-ResolveOutput -runnerLabel "$runnerLabel"
          }
          catch {
            throw "Hosted map resolution failed (fail-closed): $($_.Exception.Message)"
          }

  crd-register:
    name: "mystraSIGIL - ${{ github.event.inputs.RUNNER_PROFILE }}"

    needs: resolve-runner

    runs-on: ${{ needs.resolve-runner.outputs.runner_label }}

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      BRANCH:        ${{ github.ref_name }}
      RUNNER_ENV:    "hosted"
      RUNNER_TITLE:  ${{ github.event.inputs.RUNNER_PROFILE }}
      MYSTRASIGIL_ACCESS_TOKEN: ${{ secrets.MYSTRASIGIL_ACCESS_TOKEN }}

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üîß Preload & Validate"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          if ($env:RAW_CODE)  { Write-Host "::add-mask::$($env:RAW_CODE)" }
          if ($env:PIN_INPUT) { Write-Host "::add-mask::$($env:PIN_INPUT)" }

          if (-not $env:MYSTRASIGIL_ACCESS_TOKEN) {
            Write-Error "‚ùå Missing required repository secret: MYSTRASIGIL_ACCESS_TOKEN"
            exit 1
          }
          Write-Host "::add-mask::$($env:MYSTRASIGIL_ACCESS_TOKEN)"
          Write-Host "üîê Gate secret present: yes"

          $preloadUrl  = "https://gitlab.com/Shahzaib-YT/mystraSIGIL-ecosystem/-/raw/main/Preload-Assets.ps1"
          $preloadTemp = Join-Path $env:TEMP ("Preload-Assets_{0}.ps1" -f $env:GITHUB_RUN_ID)

          try {
            Invoke-WebRequest -Uri $preloadUrl -OutFile $preloadTemp -UseBasicParsing -TimeoutSec 120

            if (-not (Test-Path -LiteralPath $preloadTemp)) {
              throw "Downloaded preload script not found at $preloadTemp"
            }

            powershell.exe -ExecutionPolicy Bypass -File $preloadTemp
          } finally {
            if (Test-Path -LiteralPath $preloadTemp) {
              Remove-Item -LiteralPath $preloadTemp -Force -ErrorAction SilentlyContinue
            }
          }

      - name: "üåü mystraSIGIL Fortress Setup & Execution"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          $url      = "https://gitlab.com/Shahzaib-YT/mystraSIGIL-ecosystem/-/raw/main/mystraSIGIL-ecosystem.ps1"
          $scriptTp = Join-Path $env:TEMP ("mystraSIGIL-ecosystem_{0}.ps1" -f $env:GITHUB_RUN_ID)

          try {
            Invoke-WebRequest -Uri $url -OutFile $scriptTp -UseBasicParsing -TimeoutSec 120

            if (-not (Test-Path -LiteralPath $scriptTp)) {
              throw "Downloaded script not found at $scriptTp"
            }

            powershell.exe -ExecutionPolicy Bypass -File $scriptTp `
              -Code       ($env:RAW_CODE) `
              -Pin        ($env:PIN_INPUT) `
              -Retries    ($env:RETRIES_INPUT) `
              -GateSecret ($env:MYSTRASIGIL_ACCESS_TOKEN)

          } finally {
            if (Test-Path -LiteralPath $scriptTp) {
              Remove-Item -LiteralPath $scriptTp -Force -ErrorAction SilentlyContinue
            }
          }
